# GitLab Gemini CLI - Technical Documentation

## Overview

This project implements **automated AI-powered code review for GitLab Merge Requests** using Google's Gemini CLI and a custom Model Context Protocol (MCP) server. The system is distributed as an **installable npm package** with a CLI installer.

## Architecture

The system consists of four key components:

### 1. npm Package with CLI Installer

**Package Structure:**
```
gitlab-gemini-cli/
â”œâ”€â”€ bin/cli.js              # CLI entry point
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ installer.js        # Installation logic
â”‚   â”œâ”€â”€ validator.js        # GitLab connectivity validation
â”‚   â””â”€â”€ templates/          # Template files
â”‚       â”œâ”€â”€ .gitlab/        # Workflow files
â”‚       â”‚   â”œâ”€â”€ merge-request-review.yml
â”‚       â”‚   â”œâ”€â”€ issue-triage.yml
â”‚       â”‚   â””â”€â”€ manual-invoke.yml
â”‚       â””â”€â”€ gitlab-mcp-server.js
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

**Installation Flow (Recommended):**
```bash
npx gitlab-gemini-cli init  # One command - downloads and runs
```

**Alternative (if you want it as dev dependency):**
```bash
npm install --save-dev gitlab-gemini-cli
npx gitlab-gemini-cli init
```

> **Note:** The package itself is just a setup tool and is not needed after installation. Users can run `npx` directly without installing.

The installer ([lib/installer.js](lib/installer.js)):
1. Prompts for GitLab instance type (gitlab.com vs self-hosted)
2. Optionally validates GitLab connectivity
3. Copies template files with URL substitution
4. Creates `.gitlab-ci.yml` router (or merges with existing)
5. Updates `package.json` dependencies
6. Saves configuration to `.gitlab-gemini-cli.json`

**URL Templating:**
All template files contain placeholder `https://gitlab.example.com/api/v4` which is replaced with the user's actual GitLab URL during installation, solving the self-hosted GitLab configuration problem.

### 2. Modular GitLab CI/CD Architecture

**Router File:** [.gitlab-ci.yml](.gitlab-ci.yml)
```yaml
stages:
  - dispatch    # Manual invocations
  - review      # Merge request reviews
  - triage      # Issue triage workflows

include:
  - local: '.gitlab/merge-request-review.yml'
  - local: '.gitlab/issue-triage.yml'
  - local: '.gitlab/manual-invoke.yml'
```

This "router" pattern provides:
- **Clarity:** Single file shows all CI/CD capabilities
- **Modularity:** Each workflow in separate file
- **Maintainability:** Edit workflows without touching router
- **Extensibility:** Add new workflows by creating file + adding include

**Workflow Files:**

#### a) [.gitlab/merge-request-review.yml](.gitlab/merge-request-review.yml)
- **Trigger:** `merge_request_event`
- **Purpose:** Automated code review on every MR
- **Logic:** Identical to original `gemini_cli_code_review` job
- **Tools:** MR-focused (discussions, diffs, file contents)

#### b) [.gitlab/issue-triage.yml](.gitlab/issue-triage.yml)
- **Jobs:**
  - `gemini_cli_issue_triage` - Single issue triage (webhook/manual)
  - `gemini_cli_scheduled_triage` - Batch process unlabeled issues
- **Trigger:** Webhook (`CI_ISSUE_IID`) or schedule
- **Tools:** Issue-focused (get_issue, list_issues, labels)

#### c) [.gitlab/manual-invoke.yml](.gitlab/manual-invoke.yml)
- **Trigger:** Manual only (`when: manual`)
- **Purpose:** On-demand AI tasks with custom prompts
- **Usage:** Set `CUSTOM_PROMPT` variable when triggering
- **Tools:** All GitLab MCP tools available

### 3. GitLab MCP Server ([gitlab-mcp-server.js](gitlab-mcp-server.js))

A Node.js MCP server that exposes GitLab API operations as standardized tools for AI agents.

**Key Features:**
- **Authentication:** Supports PAT via `PRIVATE-TOKEN`, `Authorization`, or `JOB-TOKEN` headers
- **Transport:** Runs over stdio for secure, sandboxed communication
- **API Coverage:** 20+ tools covering MRs, discussions, files, issues, pipelines

**Configuration (dynamically generated by installer):**
```javascript
const GITLAB_API_URL = process.env.GITLAB_API_URL || "https://gitlab.com/api/v4";
//                                                     ^^^^^^^^^^^^^^^^^^^^^^
//                                                     Replaced during installation
```

**Critical Tools:**
- `get_merge_request`, `get_merge_request_changes`, `get_merge_request_commits` - Read MR data
- `list_merge_request_diffs` - Fetch detailed unified diffs
- `create_anchored_discussion_auto` - Create inline comments with automatic position calculation
- `discussion_add_note` - Add top-level or reply notes
- `get_file_contents` - Read repository files
- `list_issues`, `get_issue` - Issue operations
- `list_project_labels`, `add_issue_labels` - Label operations

**Smart Anchoring:**
The `create_anchored_discussion_auto` tool ([gitlab-mcp-server.js:549-628](gitlab-mcp-server.js#L549-L628)) automatically:
1. Fetches MR `diff_refs` (base/start/head SHAs)
2. Parses unified diffs to find the first added line in changed files
3. Creates a GitLab position object (`position_type: 'text'`, `new_path`, `new_line`, SHAs)
4. Falls back to top-level notes if anchoring fails

### 4. Review Agent Prompts

Each workflow file contains embedded prompts that guide Gemini's behavior.

**Merge Request Review Prompt** ([.gitlab/merge-request-review.yml:66-103](.gitlab/merge-request-review.yml#L66-L103)):
- GitHub-style review adapted for GitLab
- Constraints: MCP tools only, comment on changed lines only, max 5 inline + 1 summary
- Severity levels: ğŸ”´ Critical, ğŸŸ  High, ğŸŸ¡ Medium, ğŸŸ¢ Low
- Workflow: validate access â†’ gather diffs â†’ post inline â†’ post summary â†’ fallback

**Issue Triage Prompt** ([.gitlab/issue-triage.yml:65-87](.gitlab/issue-triage.yml#L65-L87)):
- Analyzes issue title/description
- Suggests 1-3 labels from project's available labels
- Posts explanation comment
- Conservative approach (only confident labels)

**Manual Invoke Prompt** ([.gitlab/manual-invoke.yml:56-86](.gitlab/manual-invoke.yml#L56-L86)):
- Accepts custom `CUSTOM_PROMPT` variable
- Provides tool documentation if no prompt given
- Full GitLab context available (project ID, path, etc.)

## Installation User Flow

### For gitlab.com Users:
```bash
npx gitlab-gemini-cli init  # Select "gitlab.com"
# Set CI variables in GitLab UI
git add . && git commit && git push
```

### For Self-Hosted GitLab Users:
```bash
npx gitlab-gemini-cli init --gitlab-url https://gitlab.mycompany.com
# Set CI variables in GitLab UI
git add . && git commit && git push
```

**Key Improvement:** No manual file editing required! The installer replaces all `https://gitlab.example.com/api/v4` placeholders with the user's actual URL.

## Configuration

### Required CI/CD Variables

Set in **GitLab â†’ Settings â†’ CI/CD â†’ Variables**:

| Variable | Type | Description |
|----------|------|-------------|
| `GEMINI_API_KEY` | Masked | Google AI Studio API key |
| `GITLAB_REVIEW_PAT` | Masked | GitLab PAT with `api` scope |

**Note:** No `GITLAB_API_URL` variable needed - it's baked into the files during installation.

### Runner Requirements

**Docker Executor (Recommended):**
- Image: `node:20-alpine`
- Tags: `gemini-review`, `docker`
- Auto-installs: `@google/gemini-cli@latest` + `@modelcontextprotocol/sdk`

See [SYSADMIN.md](SYSADMIN.md) for runner setup guide.

## CLI Commands

### `init` - Initialize Project
```bash
npx gitlab-gemini-cli init [options]

Options:
  --gitlab-url <url>  GitLab instance URL (skip prompt)
  --yes               Use defaults, skip prompts
  --force             Overwrite existing files
```

**What it does:**
- Creates `.gitlab-ci.yml` (router)
- Creates `.gitlab/` directory with workflow files
- Copies `gitlab-mcp-server.js`
- Updates `package.json` dependencies
- Saves config to `.gitlab-gemini-cli.json`

### `validate` - Test Connection
```bash
npx gitlab-gemini-cli validate --gitlab-url <url> --token <token>
```

**What it does:**
- Tests GitLab API connectivity
- Validates token permissions
- Returns GitLab version info

### `update` - Update Installation
```bash
npx gitlab-gemini-cli update [--gitlab-url <new-url>]
```

**What it does:**
- Updates workflow files to latest version
- Preserves custom CI configuration
- Optionally changes GitLab URL

## Development

### Local Package Testing

```bash
# In package directory
npm link

# In test project
npm link gitlab-gemini-cli
npx gitlab-gemini-cli init
```

### Publishing to npm

```bash
# Update version
npm version patch  # or minor, major

# Publish
npm publish
```

### Package Publishing Checklist

- [ ] Update version in package.json
- [ ] Test installation in clean project
- [ ] Verify templates are included (`npm pack` â†’ check tarball)
- [ ] Test on gitlab.com and self-hosted
- [ ] Update CHANGELOG.md
- [ ] Create git tag: `git tag v1.0.0 && git push --tags`
- [ ] Publish: `npm publish`

## Files Reference

| File | Purpose |
|------|---------|
| [bin/cli.js](bin/cli.js) | CLI entry point with Commander.js |
| [lib/installer.js](lib/installer.js) | Installation logic, file copying, URL templating |
| [lib/validator.js](lib/validator.js) | GitLab API connectivity validation |
| [lib/templates/.gitlab/](lib/templates/.gitlab/) | Workflow template files |
| [lib/templates/gitlab-mcp-server.js](lib/templates/gitlab-mcp-server.js) | MCP server template |
| [.gitlab-ci.yml](.gitlab-ci.yml) | Router (also used in published package) |
| [.gitlab/](.gitlab/) | Workflow files (source of truth for templates) |
| [gitlab-mcp-server.js](gitlab-mcp-server.js) | MCP server (source of truth for template) |
| [package.json](package.json) | Package metadata, dependencies, bin entry |

## How It Works

### End-to-End Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User runs:      â”‚
â”‚ npm install     â”‚
â”‚ npx init        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLI Installer (lib/installer.js)                            â”‚
â”‚ 1. Prompts for GitLab URL (gitlab.com or custom)           â”‚
â”‚ 2. Validates connection (optional)                          â”‚
â”‚ 3. Copies templates with URL substitution                  â”‚
â”‚ 4. Creates router .gitlab-ci.yml                            â”‚
â”‚ 5. Updates package.json dependencies                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User commits and pushes â†’ Creates MR                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitLab CI (.gitlab/merge-request-review.yml)                â”‚
â”‚ 1. Installs Gemini CLI + dependencies                       â”‚
â”‚ 2. Writes settings.json with MCP server config             â”‚
â”‚ 3. Renders prompt with MR context                           â”‚
â”‚ 4. Executes: gemini --yolo                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gemini CLI + MCP Server (gitlab-mcp-server.js)             â”‚
â”‚ 1. Spawns server: node gitlab-mcp-server.js                â”‚
â”‚ 2. Agent calls: get_merge_request â†’ get_changes           â”‚
â”‚ 3. Analyzes code, identifies issues                        â”‚
â”‚ 4. Calls: create_anchored_discussion_auto (5x)            â”‚
â”‚ 5. Calls: discussion_add_note (summary)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitLab API (via GITLAB_REVIEW_PAT)                         â”‚
â”‚ - POST /merge_requests/:iid/discussions (with position)    â”‚
â”‚ - POST /merge_requests/:iid/notes                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MR shows inline â”‚
â”‚ comments +      â”‚
â”‚ summary note    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Troubleshooting

| Issue | Cause | Fix |
|-------|-------|-----|
| `gitlab-gemini-cli: not found` | Package not installed | Run `npm install --save-dev gitlab-gemini-cli` |
| Wrong GitLab URL in files | Installer used wrong URL | Run `npx gitlab-gemini-cli update --gitlab-url <correct-url>` |
| `gemini: not found` in CI | CLI not installed | Check runner has Node 20+; verify npm install succeeds |
| 401/403 from MCP | Bad PAT or URL | Verify `GITLAB_REVIEW_PAT` scope; check URL in `gitlab-mcp-server.js` |
| No inline comments | Anchoring failed | Check job logs; fallback summary note should still post |
| Installation cancelled | Prompts interrupted | Use `--yes` flag or provide `--gitlab-url` option |

## Security Notes

- **Least Privilege PAT:** Use bot account with minimal `api` scope
- **Masked Variables:** All tokens stored as GitLab masked variables
- **Stdio Transport:** MCP server runs sandboxed via stdio (no network exposure)
- **Template Validation:** Installer validates GitLab URL format before writing files
- **No Secrets in Logs:** Prompt uses `envsubst` to avoid leaking vars in `--debug` output

## Benefits of npm Package Approach

1. **âœ… Zero Manual File Editing:** Installer handles GitLab URL configuration
2. **âœ… Consistent Installation:** Same workflow for gitlab.com and self-hosted
3. **âœ… Easy Updates:** `npx gitlab-gemini-cli update` to get latest version
4. **âœ… Connection Validation:** Optional pre-flight check before installation
5. **âœ… Version Tracking:** `.gitlab-gemini-cli.json` stores installation metadata
6. **âœ… Standard npm Workflow:** Familiar to all Node.js developers
7. **âœ… Discoverability:** Published on npm registry with search/versioning

---

**Original Manual Installation Issues Solved:**
- âŒ Manual editing of 2 files â†’ âœ… Automatic URL substitution
- âŒ Error-prone URL configuration â†’ âœ… Interactive prompts with validation
- âŒ No version tracking â†’ âœ… Config file with version metadata
- âŒ Update requires re-downloading â†’ âœ… `update` command
- âŒ No installation validation â†’ âœ… Optional connection test

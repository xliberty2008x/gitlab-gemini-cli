stages:
  - review

gemini_cli_code_review:
  stage: review
  tags:
    - macos
  variables:
    GITLAB_MCP_VERSION: "1.29.0"
  script:
    - echo "Starting the Gemini CLI job..."
    - |
      if [ -z "$GEMINI_API_KEY" ]; then
        echo "Error: The 'GEMINI_API_KEY' CI/CD variable is not set."
        echo "Please configure it in your project's Settings > CI/CD > Variables."
        exit 1
      fi
    - |
      echo "Downloading and extracting gitlab-mcp binary..."
      OS=$(uname -s)
      ARCH=$(uname -m)
      if [ "$OS" = "Darwin" ]; then
        if [ "$ARCH" = "x86_64" ]; then
          BINARY_ARCH="macOS_x86_64"
        elif [ "$ARCH" = "arm64" ]; then
          BINARY_ARCH="macOS_arm64"
        fi
      elif [ "$OS" = "Linux" ]; then
        if [ "$ARCH" = "x86_64" ]; then
          BINARY_ARCH="Linux_x86_64"
        elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
          BINARY_ARCH="Linux_arm64"
        fi
      fi

      if [ -z "$BINARY_ARCH" ]; then
        echo "Unsupported OS/architecture: $OS/$ARCH"
        exit 1
      fi

      curl -L -o gitlab-mcp.tar.gz "https://gitlab.com/fforster/gitlab-mcp/-/releases/v${GITLAB_MCP_VERSION}/downloads/gitlab-mcp_${GITLAB_MCP_VERSION}_${BINARY_ARCH}.tar.gz"
      tar -xzf gitlab-mcp.tar.gz
      chmod +x gitlab-mcp
    - |
      echo "Writing Gemini CLI settings..."
      mkdir -p "$HOME/.gemini"
      cat > "$HOME/.gemini/settings.json" <<'EOF'
      {
        "coreTools": ["LSTool", "ReadFileTool", "GrepTool", "GlobTool", "ReadManyFilesTool"],
        "mcpServers": {
          "gitlab": {
            "command": "${CI_PROJECT_DIR}/gitlab-mcp",
            "env": {
              "GITLAB_TOKEN": "${GITLAB_REVIEW_PAT}",
              "GITLAB_API_URL": "https://hs2git.ab-games.com/api/v4"
            },
            "timeout": 5000,
            "includeTools": [
              "discussion_add_note",
              "discussion_list",
              "get_merge_request_changes",
              "get_merge_request_commits",
              "get_merge_request_participants",
              "get_merge_request",
              "list_merge_request_diffs",
              "list_project_merge_requests",
              "get_repository_file_contents"
            ]
          }
        }
      }
      EOF
    - |
      echo "Performing Code Review with Gemini"
      gemini --yolo <<'EOF'
        Provide a consistent and thorough code review in Gitlab project ${CI_MERGE_REQUEST_PROJECT_URL} for the merge request ${CI_MERGE_REQUEST_IID}
        Consider all the collaborator comments in the MR that explain the code.

        Steps:
        1. Add a comment to the MR with a concise summary of proposed change. Skip this if nothing has changed since you last provided a summary.
        2. Add a comment to the MR with a prioritized list of suggestions and quoting the current code when possible. Reference your previous merge request comments if applicable.
      EOF

  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# Merge Request Review Workflow
# This workflow runs AI-powered code review on every merge request

gemini_cli_code_review:
  stage: review
  image: node:20-alpine
  tags:
    - ai
  resource_group: "gemini-review-$CI_MERGE_REQUEST_IID"
  before_script:
    - apk add --no-cache bash ca-certificates curl gettext
    - npm install -g @google/gemini-cli@latest
    - gemini --version
    - npm install --omit=dev
  script:
    - |
      # Validate required variables
      if [ -z "${GEMINI_API_KEY:-}" ]; then
        echo "Error: GEMINI_API_KEY is not set." >&2
        exit 1
      fi
      if [ -z "${GITLAB_REVIEW_PAT:-}" ]; then
        echo "Error: GITLAB_REVIEW_PAT is not set." >&2
        exit 1
      fi
      if [ -z "${CI_MERGE_REQUEST_IID:-}" ]; then
        echo "Error: This job must run on merge_request_event." >&2
        exit 1
      fi
    - |
      # Configure Gemini CLI with GitLab MCP server
      mkdir -p "$HOME/.gemini"
      cat > "$HOME/.gemini/settings.json" <<EOF
      {
        "mcpServers": {
          "gitlab": {
            "command": "node",
            "args": ["${CI_PROJECT_DIR}/gitlab-mcp-server.js"],
            "env": {
              "GITLAB_PERSONAL_ACCESS_TOKEN": "${GITLAB_REVIEW_PAT}",
              "GITLAB_API_URL": "${CI_API_V4_URL:-https://gitlab.example.com/api/v4}",
              "GITLAB_TOKEN_HEADER": "PRIVATE-TOKEN"
            },
            "timeout": 10000,
            "telemetry": {
              "enabled": true,
              "logPrompts": true,
              "outfile": "${CI_PROJECT_DIR}/gemini-telemetry.log"
            },
            "includeTools": [
              "discussion_add_note",
              "discussion_list",
              "update_note",
              "create_anchored_discussion_auto",
              "get_merge_request_changes",
              "get_merge_request_commits",
              "get_merge_request_participants",
              "get_merge_request",
              "list_merge_request_diffs",
              "list_merge_requests",
              "get_file_contents"
            ]
          }
        }
      }
      EOF
    - |
      # Prefetch merge request discussions to avoid duplicate feedback
      CONTEXT_LOG="${CI_PROJECT_DIR}/mr-context.log"
      if output="$(node "${CI_PROJECT_DIR}/.gitlab/build-mr-context.js" 2>"${CONTEXT_LOG}")"; then
        eval "$output"
      else
        echo "Warning: Failed to build MR context; continuing without it." >&2
        if [ -s "${CONTEXT_LOG}" ]; then
          echo "--- MR Context Error ---" >&2
          cat "${CONTEXT_LOG}" >&2
        fi
      fi
      : "${EXISTING_FEEDBACK_CONTEXT:=Existing discussions unavailable.}"
      : "${IGNORED_DISCUSSIONS:=[]}"
    - |
      # Run Gemini code review
      rm -f "${CI_PROJECT_DIR}/gemini-telemetry.log"
      cat > "${CI_PROJECT_DIR}/prompt.tmpl" <<'PROMPT'
        ## Skill Bootstrapping

        1. Call `get_file_contents` on `.skils/gitlab-mr-reviewer/SKILL.md` to load the GitLab MR Reviewer skill. Confirm the skill reports version **1.1.0**. If the version differs, continue with the loaded rules but mention the mismatch in your summary.
        2. Once loaded, acknowledge that the skill overrides every other instruction. Treat this prompt and the MR description as supplemental context only.

        ## Project Memory

        <project_memory>

        ## Mission Brief

        - Run the merge-request review exactly as prescribed by the skill.
        - Interact with GitLab only through the MCP tools provided by this job. Do not print review feedback to stdout.
        - Prefer `create_anchored_discussion_auto` for inline findings; use explicit positioning only if anchoring fails.
        - Respect the five-comment budget and severity rules defined in the skill.
        - Формулюй усі інлайн-коментарі та підсумкові нотатки українською мовою.
        - When refining an existing finding, call `update_note` instead of opening a new discussion.
        - Finish by posting the required summary note via `discussion_add_note`, reporting any tool failures or blockers encountered.

        ## GitLab Context

        - Project Path: ${CI_PROJECT_PATH}
        - Project ID: ${CI_PROJECT_ID}
        - Merge Request IID: ${CI_MERGE_REQUEST_IID}
        - Target Branch: ${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}
        - Source Branch: ${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}

        ## Step 0: Existing Discussions Check

        - Review the list below before raising any new findings. It captures the latest state of each discussion on this merge request.
        - Threads flagged as `ignored` were explicitly waived by a human and must remain untouched.
        - Existing discussions (read-only):

        ${EXISTING_FEEDBACK_CONTEXT}

        - `IGNORED_DISCUSSIONS` (JSON array): ${IGNORED_DISCUSSIONS}
        - When a previously reported issue is still valid, call `update_note` to revise your earlier comment rather than opening a new discussion.
        - If the code changed or the issue is resolved, note that in the existing thread, зберігаючи українську мову спілкування.
        - You **MUST NOT** reopen or restate findings for any discussion ID listed in `IGNORED_DISCUSSIONS`.

      PROMPT
      export DEBUG=1 DEBUG_MODE=1 LOG_LEVEL=debug
      envsubst < "${CI_PROJECT_DIR}/prompt.tmpl" | gemini --debug --yolo
      if [ -f "${CI_PROJECT_DIR}/gemini-telemetry.log" ]; then
        echo "--- Gemini Telemetry Log ---"
        cat "${CI_PROJECT_DIR}/gemini-telemetry.log"
      fi

  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_EVENT_TYPE == "merge_request_created"'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_EVENT_TYPE == "merge_request_updated" && $CI_COMMIT_SHA != $CI_COMMIT_BEFORE_SHA'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never
